<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Service</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h2 style="text-align:center;">Book Service</h2>

<form id="bookingForm" class="form">

  <!-- Service (auto-filled, read-only) -->
  <input type="text" id="service" placeholder="Service" readonly>

  <!-- Sub Service (auto-filled, read-only) -->
  <input type="text" id="subService" placeholder="Sub Service" readonly>

  <input type="text" id="name" placeholder="Your Name" required>
  <input type="email" id="email" placeholder="Email">
  <input type="tel" id="phone" placeholder="Phone Number" required>

  <textarea id="description" placeholder="Describe your problem" required></textarea>

  <button type="submit">Submit Booking</button>

  <p id="message" style="margin-top:15px;text-align:center;"></p>
</form>

<script>
  /* -----------------------------
     READ URL PARAMETERS SAFELY
  ------------------------------*/
  const params = new URLSearchParams(window.location.search);

  const serviceInput = document.getElementById("service");
  const subServiceInput = document.getElementById("subService");

  // FORCE set values (important fix)
  serviceInput.value = params.get("service") ?? "";
  subServiceInput.value = params.get("sub") ?? "";

  /* -----------------------------
     HANDLE FORM SUBMISSION
  ------------------------------*/
  document.getElementById("bookingForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const data = {
      service: serviceInput.value.trim(),
      sub_service: subServiceInput.value.trim(),   // IMPORTANT: underscore
      name: document.getElementById("name").value.trim(),
      email: document.getElementById("email").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      description: document.getElementById("description").value.trim()
    };

    /* -----------------------------
       FRONTEND VALIDATION
    ------------------------------*/
    if (!data.service || !data.sub_service || !data.name || !data.phone || !data.description) {
      document.getElementById("message").style.color = "red";
      document.getElementById("message").innerText = "❌ Missing required fields";
      return;
    }

    try {
      const response = await fetch(
        "https://electrician-backend-zdtl.onrender.com/api/bookings",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        }
      );

      const result = await response.json();

      if (response.ok) {
        document.getElementById("message").style.color = "#22d3ee";
        document.getElementById("message").innerText = "✅ Booking submitted successfully!";
        document.getElementById("bookingForm").reset();
      } else {
        document.getElementById("message").style.color = "red";
        document.getElementById("message").innerText =
          result.message || "❌ Booking failed";
      }

    } catch (error) {
      document.getElementById("message").style.color = "red";
      document.getElementById("message").innerText = "❌ Server error. Try again.";
    }
  });
</script>

</body>
</html>
